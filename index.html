<!DOCTYPE html>
<html>
	<head>
		<title>Visite de la Galerie</title>
		<meta name="viewport" content="width=device-width , initial-scale=1">
		<link rel="stylesheet" href="css/jquery.mobile-1.3.0.css" />
		<script src="lib/jquery-1.9.1.js"></script>
		<script src="lib/jquery.mobile-1.3.0.js"></script>
		<script src="lib/three.js"></script>
		<script src="lib/js/loaders/ColladaLoader.js"></script>
		<script src="Galerie.js"></script>
		<style>
			#containerInfo{
				position : absolute ;
				margin-top : 20px;
				margin-left : 20px;
				padding : 5px;
				min-width : 150px ;
				min-height : 180px;
				max-width : 150px;
				min-height : 180px;
				border : 2px solid black;
				border-radius : 6px;
				background-color : rgba(100,100,100,0.7);
				text-align : left;
				font-family : Calibri;
				font-size : 16px;
				visibility : hidden;
			}
		</style>
	</head>
<body>
	<script src="lib/js/controls/FirstPersonControls.js"></script>
	<div data-role="page">
		<div data-role="header">
			<h1>Visite de la Galerie</h1>
			<a href="tutomvt.html" data-icon="gear" class="ui-btn-right" data-rel="dialog" data-transition="slidedown">Comment se deplacer</a>
		</div>
		<div id="container" data-role="content" style="margin : 0; padding : 0">
		
		<div id="containerInfo">
			<div id="info">
			</div>
		</div>
		<script>

			var galerie = new Galerie("models/galerie/GalerieV4.dae");
			var receptionRoom = new Room("salle d'accueil",new Area(-30,82,50.5,90));
			var sculptureRoom = new ShowRoom("salle des sculptures",new Area(26.7,78,-55,50.5),29.9,2,6);
			var paintingRoom = new ShowRoom("salle des peintures",new Area(-27,17,-101,50.5),44.9,2,6);
			galerie.getRooms().push(receptionRoom,sculptureRoom,paintingRoom);
			var nbSculpture = 0;
			var nbPeinture = 0;

			for(var i = 0 ; i < nbSculpture ; i++){
				galerie.getRoom(1).addArtwork(new Artwork("sculpture "+(i+1),"20x20","inconnue","Monkey.dae","#"));
			}
			for(var i = 0 ; i < nbPeinture ; i++){
				galerie.getRoom(2).addArtwork(new Artwork("peinture "+(i+1),"30x30","inconnue","","#"));
			}
			/*
			* fonction qui retourne le nombre d'extension par rapport 
			* aux nombres d'objets,
			* le nombre d'objet dans une salle sans extension,
			* et le nombre d'objet par extension
			*/

			var render, scene, camera;
			var controls, clock = new THREE.Clock();
			var projector;
			var timerSalle;
			var tempsDansSallePeinture = 0, tempsDansSalleSculpture = 0;

			init();
			animate();

			/*
			* fonction qui initialise la scene et le rendu,
			* elle appel les fonctions chargerGalerie et chargerObjetSculpture
			*/
			function init(){
				//camera
				camera = new THREE.PerspectiveCamera(50, window.innerWidth / window.innerHeight, 1 , 20000);
				//controls
				controls = new THREE.FirstPersonControls(camera,galerie);
				controls.movementSpeed = 50;
				controls.lookSpeed = 0.1;
				controls.lookVertical = false;
				controls.noFly = true;
				//scene
				scene = new THREE.Scene();
				scene.add(camera);
				//renderer
				renderer = new THREE.WebGLRenderer({
					antialias : true
				});
				renderer.setSize( window.innerWidth, window.innerHeight-(9*window.innerHeight)/100 );
				$('#container').append( renderer.domElement );
				//event
				$(window).resize(onWindowResize);
				$(document).mousedown(onDocumentMouseDown);
				//Light
				ambientLight = new THREE.AmbientLight( 0xffffff );
            	//scene.add( ambientLight );
            	pointLight = new THREE.PointLight( 0xffffff );
            	pointLight.intensity = 0.5;
            	pointLight.position.y = 10000;
            	scene.add( pointLight );
            	directionalLight = new THREE.DirectionalLight( 0xffffff );
            	directionalLight.intensity = 0.5;
            	directionalLight.position.x = 1;
            	directionalLight.position.y = -1;
            	directionalLight.position.z = -1;
            	directionalLight.position.normalize();
            	scene.add( directionalLight );
            	//Collada Import
            	chargerGalerie(galerie,scene);
            	chargerObjetSculpture(galerie.getRoom(1),30,3,5,1,scene);
				camera.position.set(-1,0,87);
				//Ajout des objets dans la scene
				projector = new THREE.Projector();
				//timer
				timerSalle= window.setInterval("MAJTempsSalle(camera,galerie)",1000);
			
			}

			/*
			* Fonction qui charge la dans un fichier Collada
			* et ensuite les ajoutes à la scene			
			*/
			function chargerGalerie( galerie , scene ){
				var loader = new THREE.ColladaLoader();
				loader.options.convertUpAxis = true;
				var scaleValue = 10;

				loader.load( galerie.getUrlmodel() ,function( collada ){
					var cloneObject;
					var model = collada.scene;
					/*
						on parcourt tout les "children" de la scene
						on ajoute ensuite les élements qui nous interesse
						on les identifie à partir de leur nom
					*/
					for(var i=0 ; i<model.children.length ; i++){
						cloneObject = model.children[i].clone();
						cloneObject.scale.set(scaleValue,scaleValue,scaleValue);
						switch(model.children[i].name){
							case "showRoom_painting_end_segment_floor":
							case "showRoom_painting_end_segment_roof":
							case "showRoom_painting_end_segment_wall":
							case "showRoom_painting_end_segment_windowBorder":
							cloneObject.position.z -= galerie.getRoom(2).getTailleExtension()*galerie.getRoom(2).getNbExtension();
							scene.add(cloneObject.clone());
							break;

							case "showRoom_painting_middle_segment_floor":
							case "showRoom_painting_middle_segment_roof":
							case "showRoom_painting_middle_segment_wall":
							case "showRoom_painting_middle_segment_windowBorder":
							scene.add(cloneObject.clone());
							for(var idExtension = 0 ; idExtension < galerie.getRoom(2).getNbExtension() ; idExtension++){
								cloneObject.position.z -= galerie.getRoom(2).getTailleExtension();
								scene.add(cloneObject.clone());
							}
							break;

							case "showRoom_sculpture_middle_segment_roof":
							case "showRoom_sculpture_middle_segment_floor":
							case "showRoom_sculpture_middle_segment_wall":
							case "showRoom_sculpture_middle_segment_windowBorder":
							scene.add(cloneObject.clone());
							for(var idExtension = 0 ; idExtension < galerie.getRoom(1).getNbExtension() ; idExtension++){
								cloneObject.position.z -= galerie.getRoom(1).getTailleExtension();
								scene.add(cloneObject.clone());
							}
							break;

							case "showRoom_sculpture_end_segment_roof":
							case "showRoom_sculpture_end_segment_floor":
							case "showRoom_sculpture_end_segment_wall":
							case "showRoom_sculpture_end_segment_windowBorder":
							cloneObject.position.z -= galerie.getRoom(1).getTailleExtension()*galerie.getRoom(1).getNbExtension();
							scene.add(cloneObject.clone());
							break;

							case "showRoom_painting_beginning_segment_floor":
							case "showRoom_painting_beginning_segment_roof":
							case "showRoom_painting_beginning_segment_wall":
							case "showRoom_painting_beginning_segment_windowBorder":
							case "receptionRoom_floor":
							case "receptionRoom_roof":
							case "receptionRoom_wall":
							case "receptionRoom_windowBorder":
							case "showRoom_sculpture_beginning_segment_roof":
							case "showRoom_sculpture_beginning_segment_floor":
							case "showRoom_sculpture_beginning_segment_wall":
							case "showRoom_sculpture_beginning_segment_windowBorder":
							scene.add(cloneObject);
							break;
						}
					}
				});
			}

			/*
			* fonction qui permet de charger les objets 3D d'un fichier collada
			* et ensuite les ajoutes à la scene
			*/
			function chargerObjetSculpture( room, ecartObjet, ecartMur , scale, hauteur, scene ){
				var loader = new THREE.ColladaLoader();
				loader.options.convertUpAxis = true;
				var scaleValue = scale;
				console.log(room);
				var positionXGauche = room.getArea().getXMin() + ecartMur;
				var positionXDroite = room.getArea().getXMax() - ecartMur;
				var positionZGauche = 15;
				var positionZDroite = 15;
				var cloneObject;
				for( var i = 0 ; i < room.getArtworks().length ;  i++){
					var indiceSculpture = 1;
					//les sculptures sont charger une fois à gauche et la suivante a droite
					//false a useQuaternion pour que l'objet importer ne garde pas sa rotation d'origine
					//on ajoute a la scene juste les composants de la scene qui sont de type THREE.Mesh
					if(i%2 == 0){
						loader.load( "models/sculpture/"+room.getArtwork(i).getModel3D(), function(collada){
							var model = collada.scene;
							for( var j = 0 ; j < model.children.length ; j ++){
								if( model.children[j] instanceof THREE.Mesh ){
									model.children[j].useQuaternion = false;
									model.children[j].rotation.set( Math.PI/2, 0, -	Math.PI/2);
									model.children[j].scale.set( scaleValue , scaleValue , scaleValue );
									model.children[j].position.set( positionXGauche , hauteur , positionZGauche );
									model.children[j].name = "sculpture "+indiceSculpture;
									scene.add(model.children[j].clone());
								}
							}

							positionZGauche -= ecartObjet;
							indiceSculpture += 1;
						});
					}else{
						loader.load( "models/sculpture/"+room.getArtworks()[i].getModel3D(), function(collada){
							var model = collada.scene;
							for( var j = 0 ; j < model.children.length ; j++){
								if(model.children[j] instanceof THREE.Mesh){
									model.children[j].useQuaternion = false;
									model.children[j].rotation.set( Math.PI/2, 0, Math.PI/2);
									model.children[j].scale.set( scaleValue , scaleValue , scaleValue );
									model.children[j].position.set( positionXDroite , hauteur , positionZDroite );
									model.children[j].name = "sculpture "+indiceSculpture;
									scene.add(model.children[j].clone());
								}
							}

							positionZDroite -= ecartObjet;
							indiceSculpture += 1;
						});
					}
				}
				
			}


			//fonction appelé par le timer pour mettre à jour le temps passé dans une salle
			function MAJTempsSalle( cam , galerie ){
				for(var iDRoom = 0 ; iDRoom < galerie.getRooms().length ; iDRoom++){
					if(galerie.getRoom(iDRoom) instanceof ShowRoom){
						if(cam.position.x < galerie.getRoom(iDRoom).getArea().getXMax() 
							&& cam.position.x > galerie.getRoom(iDRoom).getArea().getXMin()
							&& cam.position.z < galerie.getRoom(iDRoom).getArea().getZMax()
							&& cam.position.z > galerie.getRoom(iDRoom).getArea().getZMin() - galerie.getRoom(iDRoom).getTailleExtension() * galerie.getRoom(iDRoom).getNbExtension() ){
							galerie.getRoom(iDRoom).incrementTime();
							console.log('Temps dans la '+galerie.getRoom(iDRoom).getRoomName()+' : '+galerie.getRoom(iDRoom).getTime()+'sec');
						}
					}
				}
			}



			//fonction appelé a chaque clic de l'utilisateur
			function onDocumentMouseDown(event){
				event.preventDefault();
				var vector = new THREE.Vector3( (event.clientX / window.innerWidth ) * 2 - 1, -(event.clientY / window.innerHeight ) * 2 + 1, 1);
				projector.unprojectVector(vector, camera);
				var raycaster = new THREE.Raycaster( camera.position, vector.sub(camera.position ).normalize() );
				var intersects = raycaster.intersectObjects(scene.children);

				//si le raycaster à des intersection avec un objet 
				//alors on vérifie si le premier objet de l'intersection correspond à une Sculpture ou à une peinture
				//si c'est une peinture alors on affiche les informations de l'objet
				
				if ( intersects.length > 0 ) {
					for( var iDRoom = 0 ; iDRoom < galerie.getRooms().length ; iDRoom++){
						if(galerie.getRoom(iDRoom) instanceof ShowRoom){
							for( var i = 0 ; i < galerie.getRoom(iDRoom).getArtworks().length ; i++ ){
								if( galerie.getRoom(iDRoom).getArtwork(i).getId() == intersects[0].object.name ){
									console.log("ding");
									$('#containerInfo').css('visibility','visible');
									$('#info').empty();
									$('#info').append('<p>Nom : '+galerie.getRoom(iDRoom).getArtwork(i).getId()+'');
									$('#info').append('<br>Artiste : '+galerie.getRoom(iDRoom).getArtwork(i).getAuteur()+'');
									$('#info').append('<br>Dimension : '+galerie.getRoom(iDRoom).getArtwork(i).getDimension()+'');
									$('#info').append('<br>Lien : <a href="'+galerie.getRoom(iDRoom).getArtwork(i).getLink()+'">details</a> </p>');
								}
							}
						}
					}
				}

				
			}

			//retourne true si la caméra n'est pas dans l'une des salles
			function detecteCollision(cam,galerie){
				for( var iDRoom = 0 ; iDRoom < galerie.getRooms().length ; iDRoom++){
					if( galerie.getRoom(iDRoom) instanceof ShowRoom){
						if( cam.position.x < galerie.getRoom(iDRoom).getArea().getXMax()
						&& cam.position.x > galerie.getRoom(iDRoom).getArea().getXMin()
						&& cam.position.z < galerie.getRoom(iDRoom).getArea().getZMax()
						&& cam.position.z > galerie.getRoom(iDRoom).getArea().getZMin()-galerie.getRoom(iDRoom).getTailleExtension()*galerie.getRoom(iDRoom).getNbExtension())
						return false;
					}
					if( galerie.getRoom(iDRoom) instanceof Room){
						if( cam.position.x < galerie.getRoom(iDRoom).getArea().getXMax()
						&& cam.position.x > galerie.getRoom(iDRoom).getArea().getXMin()
						&& cam.position.z < galerie.getRoom(iDRoom).getArea().getZMax()
						&& cam.position.z > galerie.getRoom(iDRoom).getArea().getZMin())
						return false;
					}
				}
				return true;
			}


			//redimensionne lors d'un changement de la taille de la fenêtre
			function onWindowResize() {
				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();		
				renderer.setSize( window.innerWidth, window.innerHeight-(9*window.innerHeight)/100 );
				controls.handleResize();
				render();

			}

			//Mise à jour de l'affichage
			function animate() {
				requestAnimationFrame( animate );
				render();

			}

			function render() {
				controls.update(clock.getDelta());
				//console.log(camera.position);
				renderer.render( scene, camera );
			}

		</script>
		</div>
	</div>
</body>
</html>